<head>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.11.0/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.11.0/firebase-database.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyC4XkzBGnzODC9TuK2lJkunJ8cixFKlCnU",
            authDomain: "wsquarepa-chat-engine.firebaseapp.com",
            databaseURL: "https://wsquarepa-chat-engine.firebaseio.com",
            projectId: "wsquarepa-chat-engine",
            storageBucket: "wsquarepa-chat-engine.appspot.com",
            messagingSenderId: "810785377587",
            appId: "1:810785377587:web:e338243cfb804629960246",
            measurementId: "G-TDQWJEV4EN"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();
    </script>

    <style>
        .disabled {
            opacity: 0.2;
            cursor: not-allowed;
            display: inline-block;
            border-radius: 4px;
            background-color: #f4511e;
            border: none;
            color: #FFFFFF;
            text-align: center;
            font-size: 10px;
            padding: 10px;
            width: 146px;
            transition: all 0.5s;
            margin: 5px;
        }

        .button {
            display: inline-block;
            border-radius: 4px;
            background-color: #f4511e;
            border: none;
            color: #FFFFFF;
            text-align: center;
            font-size: 10px;
            padding: 10px;
            width: 146px;
            transition: all 0.5s;
            cursor: pointer;
            margin: 5px;
        }

        .button span {
            cursor: pointer;
            display: inline-block;
            position: relative;
            transition: 0.5s;
        }

        .button span:after {
            /* content: '\00bb'; */
            content: "-->";
            position: absolute;
            opacity: 0;
            top: 0;
            right: -20px;
            transition: 0.5s;
        }

        .button:hover span {
            padding-right: 25px;
        }

        .button:hover span:after {
            opacity: 1;
            right: 0;
        }
    </style>
</head>
<p id="message"></p>
<input type="text" id="messageSending" placeholder="Type your message here!"> <br>
<input type="text" id="sender" placeholder="Your name!"> <br>
<button onclick="send()" class="button" id="sendButton"><span>Send!</span></button>
<script>
    function writeData(message, sender) {
        database.ref("messages/").remove()
        database.ref('messages/' + message).set({
            sender: sender
        });
        localStorage.setItem("sender", sender)
        setTimeout(function() {
            document.getElementById("sender").hidden = true
            readData()
        }, 10)
    }
    
    function readData() {
        return database.ref('/messages/').once('value').then(function(snapshot) {
            var messages = (snapshot.val()) || 'Nobody\'s sent any messages yet.';
            console.log(messages);
            var keys = ""
            if (messages != 'Nobody\'s sent any messages yet.') {
                keys = Object.keys(messages)
                var sender = messages[keys[0]]["sender"]
                document.getElementById("message").innerHTML = keys + " <br> Sent by:" + sender
            } else {
                keys = 'Nobody\'s sent any messages yet.'
                document.getElementById("message").innerHTML = keys
            }
            
        });
    }

    function send() {
        var sends = localStorage.getItem("sendsLeft")
        sends = parseInt(sends)
        console.log(sends)
        if (sends > 0) {
            var message = document.getElementById("messageSending").value
            var sender = document.getElementById("sender").value
            
            if (localStorage.getItem("sender")) {
                sender = localStorage.getItem("sender")
            }
            if (message == "" || sender == "") {
                alert("Please enter all your information")
            } else {
                writeData(message, sender)
                localStorage.setItem("sendsLeft", toString(sends - 1))
                document.getElementById("messageSending").value = ""
            }
            
            if (localStorage.getItem("sender")) {
                document.getElementById("sender").hidden = true
            }
            readData()
        } else {
            alert("You've reached your max send limit.")
        }
    }
    
    function init() {
        console.log(localStorage.getItem("sendsLeft"))
        if (localStorage.getItem("sendsLeft") != "[object Undefined]" && localStorage.getItem("sendsLeft") != null && localStorage.getItem("sendsLeft") != undefined && localStorage.getItem("sendsLeft") != NaN) {
            if (localStorage.getItem("sendsLeft") == "1") {
                readData()
                alert("You have 1 send left.")
                document.getElementById("sendButton").innerHTML = "You have 1 send left."
                document.getElementById("sendButton").style = "cursor: not-allowed"
                document.getElementById("sendButton").onclick = function() {}
                setTimeout(function() {
                    document.getElementById("sendButton").innerHTML = "<span>Send</span>"
                    document.getElementById("sendButton").style = "cursor: pointer"
                    document.getElementById("sendButton").onclick = function() {send()}
                }, 2500)
            } else if (localStorage.getItem("sendsLeft") == "0") {
                var currentdate = new Date().getTime();
                var nextDate = localStorage.getItem("resetTime")
                if (nextDate != "[object Undefined]" && nextDate != null && nextDate != undefined && nextDate != NaN) {
                    if (currentdate >= nextDate) {
                        localStorage.setItem("sendsLeft", "10")
                        localStorage.removeItem("resetTime")
                        location.reload()
                    }
                } else {
                    const ONE_HOUR = 60 * 60 * 1000
                    nextDate = currentdate + ONE_HOUR;
                    console.log(currentdate)
                    console.log(nextDate)
                    localStorage.setItem("resetTime", nextDate)
                    setInterval(function() {init()}, 1200000)
                }

                document.getElementById("sendButton").className = "disabled"
                document.getElementById("sendButton").innerHTML = "Max send limit reached. <br> Try again in a hour."
                document.getElementById("sendButton").onclick = function() {}
                
                
            } else {
                readData()
                document.getElementById("sendButton").innerHTML = "You have " + (parseInt(localStorage.getItem("sendsLeft"))) + " sends left."
                document.getElementById("sendButton").style = "cursor: not-allowed"
                document.getElementById("sendButton").onclick = function() {}
                setTimeout(function() {
                    document.getElementById("sendButton").innerHTML = "<span>Send</span>"
                    document.getElementById("sendButton").style = "cursor: pointer"
                    document.getElementById("sendButton").onclick = function() {send()}
                    
                }, 2500)
            }

            if (localStorage.getItem("sender")) {
                document.getElementById("sender").hidden = true
            }
        } else {
            localStorage.setItem("sendsLeft", "10")
            location.reload()
        }
        
    }
    
    init()
</script>